const fs = require('fs');

addCommand(
  { pattern: "^show$", access: "all", desc: "_View once messages (images/videos)_" },
  async (msg, match, sock, rawMessage) => {
    const grupId = msg.key.remoteJid;

    // Must reply to a message
    if (!msg.quotedMessage) {
      const reply = { text: "_Please reply to a view once message!_" };
      return msg.key.fromMe
        ? await sock.sendMessage(grupId, reply, { edit: msg.key })
        : await sock.sendMessage(grupId, reply, { quoted: rawMessage.messages[0] });
    }

    // Extract media
    const quoted = msg.quotedMessage;
    const media =
      quoted?.viewOnceMessage?.message?.imageMessage ||
      quoted?.viewOnceMessage?.message?.videoMessage ||
      quoted?.viewOnceMessageV2?.message?.imageMessage ||
      quoted?.viewOnceMessageV2?.message?.videoMessage ||
      quoted?.viewOnceMessageV2Extension?.message?.imageMessage ||
      quoted?.viewOnceMessageV2Extension?.message?.videoMessage ||
      quoted?.imageMessage ||
      quoted?.videoMessage;

    if (!media || (media.imageMessage?.viewOnce === false && media.videoMessage?.viewOnce === false)) {
      const reply = { text: "_Please reply to a view once message!_" };
      return msg.key.fromMe
        ? await sock.sendMessage(grupId, reply, { edit: msg.key })
        : await sock.sendMessage(grupId, reply, { quoted: rawMessage.messages[0] });
    }

    // Determine type and file path
    const type = media.imageMessage ? "image" : "video";
    const extension = type === "image" ? ".png" : ".mp4";
    const mediaPath = `./viewOnceMessage_${Math.floor(Math.random() * 1000)}${extension}`;

    const downloadMsg = msg.key.fromMe
      ? { text: "_⏳ Downloading.._", edit: msg.key }
      : { text: "_⏳ Downloading.._", quoted: rawMessage.messages[0] };
    const sentMessage = await sock.sendMessage(grupId, downloadMsg);

    // Download the media
    await global.downloadMedia(media, type, mediaPath);

    // Delete the “downloading” message
    await sock.sendMessage(grupId, { delete: msg.key.fromMe ? msg.key : sentMessage.key });

    // Send the downloaded media
    const mediaMessage = { [type]: { url: mediaPath }, caption: "_⏳ Downloaded!_" };
    await sock.sendMessage(grupId, msg.key.fromMe ? mediaMessage : { ...mediaMessage, quoted: rawMessage.messages[0] });

    // Cleanup
    if (fs.existsSync(mediaPath)) fs.unlinkSync(mediaPath);
  }
);
